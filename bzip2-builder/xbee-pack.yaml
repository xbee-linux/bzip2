schema-version: 1.0

type: builder


const:
  srcDir: /usr/src

out:
  bzip2: /opt/bzip2

provision:
  - url:
      from: https://www.sourceware.org/pub/bzip2/bzip2-{% version %}.tar.gz
      todir: "{% srcDir %}"
  - url:
      from: https://www.linuxfromscratch.org/patches/lfs/11.0/bzip2-{% version %}-install_docs-1.patch
      todir: "{% srcDir %}"
      unpack: false

build:
  - shell:
      cmds:
        - patch -Np1 -i ../bzip2-{% version %}-install_docs-1.patch
        - sed -i 's@\(ln -s -f \)$(PREFIX)/bin/@\1@' Makefile
        - sed -i 's@(PREFIX)/man@(PREFIX)/share/man@g' Makefile
        - make -f Makefile-libbz2_so
        - make clean
        - make
        - make PREFIX={% bzip2 %}/usr install
        - cp -av libbz2.so.* {% bzip2 %}/usr/lib
        - ln -sv {% bzip2 %}/usr/lib/libbz2.so.1.0.8 {% bzip2 %}/usr/lib/libbz2.so
        - cp -v bzip2-shared {% bzip2 %}/usr/bin/bzip2
        - for i in {% bzip2 %}/usr/bin/{bzcat,bunzip2}; do ln -sfv {% bzip2 %}/usr/bin/bzip2 $i; done
        - rm -fv {% bzip2 %}/usr/lib/libbz2.a
      directory: "{% srcDir %}/bzip2-{% version %}"


